#!/bin/bash
set -o nounset -o pipefail -o errexit

DIRSCRIPT=$(dirname "$(readlink -f "$0")")
. /etc/wikisettings
# shellcheck source=bin/synclock
. "$DIRSCRIPT/synclock"

SCRIPT="$WIKIDIR/extensions/Translate/scripts/processMessageChanges.php"
NAME="non-mediawiki"

php "$DIRSCRIPT/../repong/repong.php" list-projects | grep -v ^mediawiki | xargs -n1 -P4 "$DIRSCRIPT/repo" update || :

if OUTPUT=$(php "$SCRIPT" --name "$NAME" --safe-import --group=* --skipgroup=ext-*,core,mediawiki* --skip-group-sync-check)
then
	echo "$OUTPUT" | xargs -l "$DIRSCRIPT/udpcast"
else
	CODE=$?
	echo "$OUTPUT"
	"$DIRSCRIPT/udpcast" "Fatal error in autoimport!"
	exit "$CODE"
fi
