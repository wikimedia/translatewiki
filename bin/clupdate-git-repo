#!/bin/bash
set -o nounset -o pipefail -o errexit

URL=$1
DIR=$2
BRANCH=${3:-master}
UPSTREAM="origin/$BRANCH"
COMMIT=${4:-origin/$BRANCH}
FORGE=${5:-none}

# On URL change, start from scratch
if [ -d "$DIR/.git" ]
then (
	ACTUALURL="$(git -C "$DIR" config --get remote.origin.url)"
	if [ "$URL" != "$ACTUALURL" ]
	then
		echo "Re-cloning $DIR to update from $ACTUALURL to $URL";
		rm -rf "$DIR"
	fi
) fi

# Clone the repository if it's missing (will complain if non-git directory exists)
if [ ! -d "$DIR/.git" ]
then
	git clone "$URL" "$DIR"
fi

# Ensure the wanted state in the repository
cd "$DIR"
git rebase --abort &>/dev/null || :
git fetch -q
git checkout -qft -B "$BRANCH" "$UPSTREAM"
git reset -q --hard "$COMMIT"
git clean -q -f -d &>/dev/null

# This configuration part is cheap, so run it every time to ensure it's up to date
if [ "$FORGE" = 'wikimedia-gerrit' ]
then
	git config user.name 'Translation updater bot'
	git config user.email 'l10n-bot@translatewiki.net'
	git config gitreview.username 'l10n-bot'
	git config gitreview.remote origin

	# Avoid using git review --setup because it uses SCP which does not honor GIT_SSH
	if [[ ! -e .git/hooks/commit-msg ]];
	then
		mkdir -p .git/hooks
		curl -Lo .git/hooks/commit-msg https://gerrit.wikimedia.org/r/tools/hooks/commit-msg
		chmod +x .git/hooks/commit-msg
	fi
else
	git config user.name 'translatewiki.net'
	git config user.email 'l10n-bot@translatewiki.net'
fi
